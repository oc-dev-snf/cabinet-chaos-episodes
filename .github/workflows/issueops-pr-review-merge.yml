name: IssueOps review/merge episode PRs

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, review_requested]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  review-and-merge:
    if: ${{ startsWith(github.head_ref, 'issueops/episode-') && (github.event.action != 'review_requested' || github.event.requested_reviewer.login == (vars.ISSUEOPS_REVIEWER_LOGIN || 'oc-dev-snf')) }}
    runs-on: ubuntu-latest

    steps:
      - name: Inspect episode file for TODO markers
        id: inspect
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number: pr.number,
              per_page: 100,
            });

            const episodeFile = files.find(f => f.filename.startsWith('episodes/') && f.filename.endsWith('.md'))?.filename;
            if (!episodeFile) {
              core.setOutput('episode_file', '');
              core.setOutput('has_todo', 'true');
              core.setOutput('is_draft', pr.draft ? 'true' : 'false');
              return;
            }

            const contentResp = await github.rest.repos.getContent({
              owner,
              repo,
              path: episodeFile,
              ref: pr.head.sha,
            });

            const raw = Buffer.from(contentResp.data.content, 'base64').toString('utf8');
            const hasTodo = /\bTODO\b/.test(raw);

            core.setOutput('episode_file', episodeFile);
            core.setOutput('has_todo', hasTodo ? 'true' : 'false');
            core.setOutput('is_draft', pr.draft ? 'true' : 'false');

      - name: Mark PR draft state via labels
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;
            const hasTodo = '${{ steps.inspect.outputs.has_todo }}' === 'true';

            if (hasTodo) {
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['episode-draft'] });
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'ready-for-review' });
              } catch (_) {}
              return;
            }

            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['ready-for-review'] });
            try {
              await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'episode-draft' });
            } catch (_) {}

      - name: Mark PR as ready for review when complete
        if: steps.inspect.outputs.has_todo == 'false' && steps.inspect.outputs.is_draft == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            await github.graphql(`
              mutation($pullRequestId: ID!) {
                markPullRequestReadyForReview(input: { pullRequestId: $pullRequestId }) {
                  pullRequest { id number isDraft }
                }
              }
            `, { pullRequestId: pr.node_id });

      - name: Attempt squash merge when complete
        if: steps.inspect.outputs.has_todo == 'false'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            try {
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number,
                merge_method: 'squash',
              });
            } catch (err) {
              core.info(`Merge not ready yet: ${err.message}`);
            }
